name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-packages:
    name: Build ${{ matrix.bin }} for ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - bin: comenq
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - bin: comenqd
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - bin: comenq
            target: aarch64-unknown-linux-gnu
            arch: arm64
          - bin: comenqd
            target: aarch64-unknown-linux-gnu
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Prepare release version
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          echo "RELEASE_VERSION=${version}" >> "$GITHUB_ENV"
      - name: Clean dist directory
        run: rm -rf dist
      - name: Build and package ${{ matrix.bin }}
        uses: leynos/shared-actions/.github/actions/rust-build-release@7bc9b6c15964ef98733aa647b76d402146284ba3
        with:
          target: ${{ matrix.target }}
          bin-name: ${{ matrix.bin }}
          version: ${{ env.RELEASE_VERSION }}
          formats: deb,rpm
      - name: Enrich package metadata
        run: |
          set -euo pipefail
          bin='${{ matrix.bin }}'
          arch='${{ matrix.arch }}'
          target='${{ matrix.target }}'
          version='${RELEASE_VERSION}'
          rm -f dist/*.deb dist/*.rpm
          if [ "${bin}" = 'comenq' ]; then
            cat <<YAML > dist/nfpm.yaml
            name: ${bin}
            arch: ${arch}
            platform: linux
            version: ${version}
            release: 1
            section: utils
            priority: optional
            maintainer: Leynos
            homepage: https://github.com/leynos/comenq
            license: MIT
            description: >-
              CLI client that enqueues GitHub pull request comments for the comenqd daemon.
            contents:
              - src: target/${target}/release/${bin}
                dst: /usr/bin/${bin}
                file_info:
                  mode: "0755"
              - src: LICENSE
                dst: /usr/share/doc/${bin}/copyright
                file_info:
                  mode: "0644"
              - src: packaging/man/${bin}.1
                dst: /usr/share/man/man1/${bin}.1
                file_info:
                  mode: "0644"
            overrides:
              deb:
                depends: []
              rpm:
                depends: []
            YAML
          else
            cat <<YAML > dist/nfpm.yaml
            name: ${bin}
            arch: ${arch}
            platform: linux
            version: ${version}
            release: 1
            section: admin
            priority: optional
            maintainer: Leynos
            homepage: https://github.com/leynos/comenq
            license: MIT
            description: >-
              Daemon that drains the Comenq queue and posts comments to GitHub.
            contents:
              - src: target/${target}/release/${bin}
                dst: /usr/bin/${bin}
                file_info:
                  mode: "0755"
              - src: LICENSE
                dst: /usr/share/doc/${bin}/copyright
                file_info:
                  mode: "0644"
              - src: packaging/man/${bin}.1
                dst: /usr/share/man/man8/${bin}.1
                file_info:
                  mode: "0644"
              - src: packaging/linux/comenqd.service
                dst: /lib/systemd/system/comenqd.service
                file_info:
                  mode: "0644"
              - src: packaging/config/comenqd.toml
                dst: /etc/comenqd/config.toml
                type: config
                file_info:
                  mode: "0644"
            scripts:
              preinstall: packaging/linux/preinstall.sh
              postinstall: packaging/linux/postinstall.sh
              preremove: packaging/linux/preremove.sh
            overrides:
              deb:
                depends:
                  - systemd
              rpm:
                depends:
                  - systemd
            YAML
          fi
          nfpm package --packager deb -f dist/nfpm.yaml -t dist
          nfpm package --packager rpm -f dist/nfpm.yaml -t dist
      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.bin }}-${{ matrix.arch }}
          path: |
            dist/**/*.deb
            dist/**/*.rpm
            dist/nfpm.yaml
            dist/.man/**
          if-no-files-found: error
  release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs: build-packages
    steps:
      - name: Download artefacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            release-artifacts/**/*.deb
            release-artifacts/**/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
