name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-packages:
    name: Build ${{ matrix.bin }} for ${{ matrix.target }}
    runs-on: ubuntu-latest
    env:
      PACKAGE_DEB_DEPENDS: ${{ matrix.bin == 'comenqd' && 'bash, systemd' || '' }}
      PACKAGE_RPM_DEPENDS: ${{ matrix.bin == 'comenqd' && 'bash, shadow-utils, systemd' || '' }}
    strategy:
      matrix:
        include:
          - bin: comenq
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - bin: comenqd
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - bin: comenq
            target: aarch64-unknown-linux-gnu
            arch: arm64
          - bin: comenqd
            target: aarch64-unknown-linux-gnu
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Prepare release version
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          echo "RELEASE_VERSION=${version}" >> "$GITHUB_ENV"
      - name: Clean dist directory
        run: rm -rf dist
      - name: Build ${{ matrix.bin }}
        uses: leynos/shared-actions/.github/actions/rust-build-release@1479e2ffbbf1053bb0205357dfe965299b7493ed
        with:
          target: ${{ matrix.target }}
          bin-name: ${{ matrix.bin }}
          version: ${{ env.RELEASE_VERSION }}
          formats: deb,rpm
      - name: Package ${{ matrix.bin }}
        uses: leynos/shared-actions/.github/actions/linux-packages@1479e2ffbbf1053bb0205357dfe965299b7493ed
        with:
          bin-name: ${{ matrix.bin }}
          package-name: ${{ matrix.bin }}
          target: ${{ matrix.target }}
          version: ${{ env.RELEASE_VERSION }}
          formats: deb,rpm
          man-paths: dist/${{ matrix.bin }}_linux_${{ matrix.arch }}/${{ matrix.bin }}.1
          deb-depends: ${{ env.PACKAGE_DEB_DEPENDS }}
          rpm-depends: ${{ env.PACKAGE_RPM_DEPENDS }}
      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.bin }}-${{ matrix.arch }}
          path: |
            dist/**/*.deb
            dist/**/*.rpm
            dist/nfpm.yaml
            dist/.man/**
          if-no-files-found: error
  release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    needs: build-packages
    steps:
      - name: Download artefacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      - name: Create draft release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836
        with:
          tag_name: ${{ github.ref_name }}
          draft: true
          files: |
            release-artifacts/**/*.deb
            release-artifacts/**/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
