name: Release

'on':
  push:
    tags:
      - 'v*.*.*'
  workflow_call:
    inputs:
      publish:
        description: >-
          Whether the workflow should publish artefacts to the GitHub release
          associated with the tag. Defaults to `false` when invoked as a
          reusable workflow.
        required: false
        type: boolean
        default: false
      dry-run:
        description: >-
          When `true`, build artefacts without uploading them to GitHub
          releases or workflow artefacts.
        required: false
        type: boolean
        default: false
    outputs:
      version:
        description: Package version
        value: ${{ jobs.metadata.outputs.version }}
      should_publish:
        description: Whether to publish
        value: ${{ jobs.metadata.outputs.should_publish }}
      dry_run:
        description: Dry run mode
        value: ${{ jobs.metadata.outputs.dry_run }}
      should_upload_workflow_artifacts:
        description: Upload workflow artifacts
        value: ${{ jobs.metadata.outputs.should_upload_workflow_artifacts }}

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ensure_version.outputs.crate-version }}
      should_publish: ${{ steps.release_modes.outputs.should-publish }}
      dry_run: ${{ steps.release_modes.outputs.dry-run }}
      should_upload_workflow_artifacts: ${{ steps.release_modes.outputs.should-upload-workflow-artifacts }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Determine release modes
        id: release_modes
        uses: leynos/shared-actions/.github/actions/determine-release-modes@cb06757ebba47bb018ac0ade84fa5dc9ffb95020
        with:
          dry-run: ${{ inputs.dry-run }}
          publish: ${{ inputs.publish }}
      - name: Read package version
        id: ensure_version
        uses: leynos/shared-actions/.github/actions/ensure-cargo-version@cb06757ebba47bb018ac0ade84fa5dc9ffb95020
        with:
          check-tag: ${{ fromJSON(steps.release_modes.outputs.should-publish) }}

  build-packages:
    name: Build ${{ matrix.bin }} for ${{ matrix.target }}
    needs: metadata
    runs-on: ubuntu-latest
    env:
      PACKAGE_DEB_DEPENDS: ${{ matrix.bin == 'comenqd' && 'bash, systemd' || '' }}
      PACKAGE_RPM_DEPENDS: ${{ matrix.bin == 'comenqd' && 'bash, shadow-utils, systemd' || '' }}
    strategy:
      matrix:
        include:
          - bin: comenq
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - bin: comenqd
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - bin: comenq
            target: aarch64-unknown-linux-gnu
            arch: arm64
          - bin: comenqd
            target: aarch64-unknown-linux-gnu
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Clean dist directory
        run: rm -rf dist
      - name: Build ${{ matrix.bin }}
        uses: leynos/shared-actions/.github/actions/rust-build-release@cb06757ebba47bb018ac0ade84fa5dc9ffb95020
        with:
          target: ${{ matrix.target }}
          bin-name: ${{ matrix.bin }}
          manifest-path: crates/${{ matrix.bin }}/Cargo.toml
      - name: Package ${{ matrix.bin }}
        uses: leynos/shared-actions/.github/actions/linux-packages@cb06757ebba47bb018ac0ade84fa5dc9ffb95020
        with:
          bin-name: ${{ matrix.bin }}
          package-name: ${{ matrix.bin }}
          target: ${{ matrix.target }}
          version: ${{ needs.metadata.outputs.version }}
          formats: deb,rpm
          man-paths: dist/${{ matrix.bin }}_linux_${{ matrix.arch }}/${{ matrix.bin }}.1
          deb-depends: ${{ env.PACKAGE_DEB_DEPENDS }}
          rpm-depends: ${{ env.PACKAGE_RPM_DEPENDS }}
      - name: Upload artefacts
        if: fromJSON(needs.metadata.outputs.should_upload_workflow_artifacts) || needs.metadata.outputs.should_publish == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.bin }}-${{ matrix.arch }}
          path: |
            dist/**/*.deb
            dist/**/*.rpm
            dist/nfpm.yaml
            dist/.man/**
          if-no-files-found: error

  release:
    name: Publish GitHub release
    if: needs.metadata.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: [metadata, build-packages]
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Ensure release exists (draft)
        shell: bash
        run: |
          set -euo pipefail
          gh release view "${{ github.ref_name }}" >/dev/null 2>&1 || \
            gh release create "${{ github.ref_name }}" \
              --draft \
              --verify-tag \
              --notes "Automated release for ${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download artefacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - id: upload_comenq
        name: Upload comenq artefacts
        uses: leynos/shared-actions/.github/actions/upload-release-assets@cb06757ebba47bb018ac0ade84fa5dc9ffb95020
        with:
          release-tag: ${{ github.ref_name }}
          bin-name: comenq
          dist-dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - id: upload_comenqd
        name: Upload comenqd artefacts
        uses: leynos/shared-actions/.github/actions/upload-release-assets@cb06757ebba47bb018ac0ade84fa5dc9ffb95020
        with:
          release-tag: ${{ github.ref_name }}
          bin-name: comenqd
          dist-dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Check comenq upload errors
        if: steps.upload_comenq.outputs.upload-error == 'true'
        run: |
          echo "Error uploading comenq release assets:"
          printf '%s\n' "${{ steps.upload_comenq.outputs.error-message }}"
          exit 1
      - name: Check comenqd upload errors
        if: steps.upload_comenqd.outputs.upload-error == 'true'
        run: |
          echo "Error uploading comenqd release assets:"
          printf '%s\n' "${{ steps.upload_comenqd.outputs.error-message }}"
          exit 1
